{
	"class": "vulnerability",
	"id": "oval:com.ubuntu.bionic:def:2021470720000000",
	"version": "1",
	"metadata": {
		"title": "CVE-2021-47072 on Ubuntu 18.04 LTS (bionic) - medium",
		"description": "In the Linux kernel, the following vulnerability has been resolved: btrfs:fix removed dentries still existing after log is synced When we move oneinode from one directory to another and both the inode and its previousparent directory were logged before, we are not supposed to have the dentryfor the old parent if we have a power failure after the log is synced. Onlythe new dentry is supposed to exist. Generally this works correctly,however there is a scenario where this is not currently working, becausethe old parent of the file/directory that was moved is not authoritativefor a range that includes the dir index and dir item keys of the olddentry. This case is better explained with the following example andreproducer: # The test requires a very specific layout of keys and items inthe # fs/subvolume btree to trigger the bug. So we want to make sure that #on whatever platform we are, we have the same leaf/node size. # # Currentlyin btrfs the node/leaf size can not be smaller than the page # size (but itcan be greater than the page size). So use the largest # supportednode/leaf size (64K). $ mkfs.btrfs -f -n 65536 /dev/sdc $ mount /dev/sdc/mnt # \"testdir\" is inode 257. $ mkdir /mnt/testdir $ chmod 755/mnt/testdir # Create several empty files to have the directory \"testdir\"with its # items spread over several leaves (7 in this case). $ for ((i =1; i <= 1200; i++)); do echo -n > /mnt/testdir/file$i done # Create ourtest directory \"dira\", inode number 1458, which gets all # its items inleaf 7. # # The BTRFS_DIR_ITEM_KEY item for inode 257 (\"testdir\") thatpoints to # the entry named \"dira\" is in leaf 2, while theBTRFS_DIR_INDEX_KEY # item that points to that entry is in leaf 3. # # Forthis particular filesystem node size (64K), file count and file # names, weendup with the directory entry items from inode 257 in # leaves 2 and 3, aspreviously mentioned - what matters for triggering # the bug exercised bythis test case is that those items are not placed # in leaf 1, they must beplaced in a leaf different from the one # containing the inode item forinode 257. # # The corresponding BTRFS_DIR_ITEM_KEY and BTRFS_DIR_INDEX_KEYitems for # the parent inode (257) are the following: # # item 460 key (257DIR_ITEM 3724298081) itemoff 48344 itemsize 34 # location key (1458INODE_ITEM 0) type DIR # transid 6 data_len 0 name_len 4 # name: dira # #and: # # item 771 key (257 DIR_INDEX 1202) itemoff 36673 itemsize 34 #location key (1458 INODE_ITEM 0) type DIR # transid 6 data_len 0 name_len 4# name: dira $ mkdir /mnt/testdir/dira # Make sure everything done so faris durably persisted. $ sync # Now do a change to inode 257 (\"testdir\")that does not result in # COWing leaves 2 and 3 - the leaves that containthe directory items # pointing to inode 1458 (directory \"dira\"). # #Changing permissions, the owner/group, updating or adding a xattr, # etc,will not change (COW) leaves 2 and 3. So for the sake of # simplicitychange the permissions of inode 257, which results in # updating its inodeitem and therefore change (COW) only leaf 1. $ chmod 700 /mnt/testdir # Nowfsync directory inode 257. # # Since only the first leaf was changed/COWed,we log the inode item of # inode 257 and only the dentries found in thefirst leaf, all have a # key type of BTRFS_DIR_ITEM_KEY, and no keys oftype # BTRFS_DIR_INDEX_KEY, because they sort after the former type andnone # exist in the first leaf. # # We also log 3 items that representranges for dir items and dir # indexes for which the log is authoritative:# # 1) a key of type BTRFS_DIR_LOG_ITEM_KEY, which indicates the log is #authoritative for all BTRFS_DIR_ITEM_KEY keys that have an offset # in therange [0, 2285968570] (the offset here is th ---truncated---",
		"affected": {
			"family": "unix",
			"platform": "Ubuntu 18.04 LTS"
		},
		"reference": {
			"source": "CVE",
			"ref_id": "CVE-2021-47072",
			"ref_url": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-47072"
		},
		"advisory": {
			"severity": "Medium",
			"rights": "Copyright (C) 2024 Canonical Ltd.",
			"public_date": "2024-03-01 22:15:00 UTC",
			"cve": {
				"text": "CVE-2021-47072",
				"href": "https://ubuntu.com/security/CVE-2021-47072",
				"public": "20240301"
			}
		}
	},
	"notes": {},
	"criteria": {
		"criterias": [
			{
				"operator": "OR",
				"criterions": [
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000000",
						"comment": "linux package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000040",
						"comment": "linux-hwe: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'replaced by linux-hwe-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000220",
						"comment": "linux-hwe-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000090",
						"comment": "linux-kvm package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000030",
						"comment": "linux-aws package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000150",
						"comment": "linux-aws-5.0: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000200",
						"comment": "linux-aws-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000270",
						"comment": "linux-aws-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000070",
						"comment": "linux-azure: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000190",
						"comment": "linux-azure-4.15 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201585530000000",
						"comment": "linux-azure-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000240",
						"comment": "linux-azure-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000080",
						"comment": "linux-gcp: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000210",
						"comment": "linux-gcp-4.15 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000130",
						"comment": "linux-gcp-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000260",
						"comment": "linux-gcp-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000050",
						"comment": "linux-gke-4.15: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gke-5.0')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000280",
						"comment": "linux-gke-5.4: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000290",
						"comment": "linux-gkeop-5.4: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000310",
						"comment": "linux-ibm-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000110",
						"comment": "linux-oracle package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000140",
						"comment": "linux-oracle-5.0: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oracle-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000180",
						"comment": "linux-oracle-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oracle-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000250",
						"comment": "linux-oracle-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000100",
						"comment": "linux-oem: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'replaced by linux-hwe-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000230",
						"comment": "linux-raspi-5.4 package in bionic is affected and may need fixing."
					}
				]
			}
		]
	}
}
