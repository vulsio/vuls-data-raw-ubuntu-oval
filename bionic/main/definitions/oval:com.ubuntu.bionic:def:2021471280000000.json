{
	"class": "vulnerability",
	"id": "oval:com.ubuntu.bionic:def:2021471280000000",
	"version": "1",
	"metadata": {
		"title": "CVE-2021-47128 on Ubuntu 18.04 LTS (bionic) - medium",
		"description": "In the Linux kernel, the following vulnerability has been resolved:bpf, lockdown, audit: Fix buggy SELinux lockdown permission checksCommit 59438b46471a (\"security,lockdown,selinux: implement SELinuxlockdown\")added an implementation of the locked_down LSM hook to SELinux, with theaimto restrict which domains are allowed to perform operations that wouldbreachlockdown. This is indirectly also getting audit subsystem involved toreportevents. The latter is problematic, as reported by Ondrej and Serhei, sinceitcan bring down the whole system via audit:  1) The audit events that are triggered due to calls tosecurity_locked_down()     can OOM kill a machine, see below details [0].  2) It also seems to be causing a deadlock viaavc_has_perm()/slow_avc_audit()     when trying to wake up kauditd, for example, when usingtrace_sched_switch()     tracepoint, see details in [1]. Triggering this was not via somehypothetical     corner case, but with existing tools like runqlat & runqslower frombcc, for     example, which make use of this tracepoint. Rough call sequence goeslike:     rq_lock(rq) -> -------------------------+       trace_sched_switch() ->               |         bpf_prog_xyz() ->                   +-> deadlock           selinux_lockdown() ->             |             audit_log_end() ->              |               wake_up_interruptible() ->    |                 try_to_wake_up() ->         |                   rq_lock(rq) --------------+What's worse is that the intention of 59438b46471a to further restrictlockdownsettings for specific applications in respect to the global lockdown policyiscompletely broken for BPF. The SELinux policy rule for the current lockdownchecklooks something like this:  allow <who> <who> : lockdown { <reason> };However, this doesn't match with the 'current' task where thesecurity_locked_down()is executed, example: httpd does a syscall. There is a tracing programattachedto the syscall which triggers a BPF program to run, which ends up doing abpf_probe_read_kernel{,_str}() helper call. The selinux_lockdown() hookdoesthe permission check against 'current', that is, httpd in this example.httpdhas literally zero relation to this tracing program, and it would benonsensicalhaving to write an SELinux policy rule against httpd to let the tracinghelperpass. The policy in this case needs to be against the entity that isinstallingthe BPF program. For example, if bpftrace would generate a histogram ofsyscallcounts by user space application:  bpftrace -e 'tracepoint:raw_syscalls:sys_enter { @[comm] = count(); }'bpftrace would then go and generate a BPF program from this internally. Onewayof doing it [for the sake of the example] could be to callbpf_get_current_task()helper and then access current->comm via one ofbpf_probe_read_kernel{,_str}()helpers. So the program itself has nothing to do with httpd or any otherrandomapp doing a syscall here. The BPF program _explicitly initiated_ thelockdowncheck. The allow/deny policy belongs in the context of bpftrace: meaning,youwant to grant bpftrace access to use these helpers, but other tracers onthesystem like my_random_tracer _not_.Therefore fix all three issues at the same time by taking a completelydifferentapproach for the security_locked_down() hook, that is, move the check intotheprogram verification phase where we actually retrieve the BPF func proto.Thisalso reliably gets the task (current) that is trying to install the BPFtracingprogram, e.g. bpftrace/bcc/perf/systemtap/etc, and it also fixes the OOMsincewe're moving this out of the BPF helper's fast-path which can be calledseveralmillions of times per second.The check is then also in line with other security_locked_down() hooks inthesystem where the enforcement is performed at open/load time, for example,open_kcore() for /proc/kcore access or module_sig_check() for modulesignaturesjust to pick f---truncated---",
		"affected": {
			"family": "unix",
			"platform": "Ubuntu 18.04 LTS"
		},
		"reference": {
			"source": "CVE",
			"ref_id": "CVE-2021-47128",
			"ref_url": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-47128"
		},
		"advisory": {
			"severity": "Medium",
			"rights": "Copyright (C) 2024 Canonical Ltd.",
			"public_date": "2024-03-15 21:15:00 UTC",
			"cve": {
				"text": "CVE-2021-47128",
				"href": "https://ubuntu.com/security/CVE-2021-47128",
				"public": "20240315"
			}
		}
	},
	"notes": {},
	"criteria": {
		"criterias": [
			{
				"operator": "OR",
				"criterions": [
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000000",
						"comment": "linux package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000040",
						"comment": "linux-hwe: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'replaced by linux-hwe-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000220",
						"comment": "linux-hwe-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000090",
						"comment": "linux-kvm package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000030",
						"comment": "linux-aws package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000150",
						"comment": "linux-aws-5.0: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000200",
						"comment": "linux-aws-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000270",
						"comment": "linux-aws-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000070",
						"comment": "linux-azure: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000190",
						"comment": "linux-azure-4.15 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201585530000000",
						"comment": "linux-azure-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000240",
						"comment": "linux-azure-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000080",
						"comment": "linux-gcp: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000210",
						"comment": "linux-gcp-4.15 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000130",
						"comment": "linux-gcp-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000260",
						"comment": "linux-gcp-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000050",
						"comment": "linux-gke-4.15: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gke-5.0')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000280",
						"comment": "linux-gke-5.4: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000290",
						"comment": "linux-gkeop-5.4: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000310",
						"comment": "linux-ibm-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000110",
						"comment": "linux-oracle package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000140",
						"comment": "linux-oracle-5.0: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oracle-5.3')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000180",
						"comment": "linux-oracle-5.3: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oracle-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000250",
						"comment": "linux-oracle-5.4 package in bionic is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000100",
						"comment": "linux-oem: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'replaced by linux-hwe-5.4')."
					},
					{
						"test_ref": "oval:com.ubuntu.bionic:tst:201245420000230",
						"comment": "linux-raspi-5.4 package in bionic is affected and may need fixing."
					}
				]
			}
		]
	}
}
