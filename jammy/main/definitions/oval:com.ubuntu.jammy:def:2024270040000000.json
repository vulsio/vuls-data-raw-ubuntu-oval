{
	"class": "vulnerability",
	"id": "oval:com.ubuntu.jammy:def:2024270040000000",
	"version": "1",
	"metadata": {
		"title": "CVE-2024-27004 on Ubuntu 22.04 LTS (jammy) - medium",
		"description": "In the Linux kernel, the following vulnerability has been resolved:clk: Get runtime PM before walking tree during disable_unusedDoug reported [1] the following hung task: INFO: task swapper/0:1 blocked for more than 122 seconds.       Not tainted 5.15.149-21875-gf795ebc40eb8 #1 \"echo 0 > /proc/sys/kernel/hung_task_timeout_secs\" disables this message. task:swapper/0       state:D stack:    0 pid:    1 ppid:     0flags:0x00000008 Call trace:  __switch_to+0xf4/0x1f4  __schedule+0x418/0xb80  schedule+0x5c/0x10c  rpm_resume+0xe0/0x52c  rpm_resume+0x178/0x52c  __pm_runtime_resume+0x58/0x98  clk_pm_runtime_get+0x30/0xb0  clk_disable_unused_subtree+0x58/0x208  clk_disable_unused_subtree+0x38/0x208  clk_disable_unused_subtree+0x38/0x208  clk_disable_unused_subtree+0x38/0x208  clk_disable_unused_subtree+0x38/0x208  clk_disable_unused+0x4c/0xe4  do_one_initcall+0xcc/0x2d8  do_initcall_level+0xa4/0x148  do_initcalls+0x5c/0x9c  do_basic_setup+0x24/0x30  kernel_init_freeable+0xec/0x164  kernel_init+0x28/0x120  ret_from_fork+0x10/0x20 INFO: task kworker/u16:0:9 blocked for more than 122 seconds.       Not tainted 5.15.149-21875-gf795ebc40eb8 #1 \"echo 0 > /proc/sys/kernel/hung_task_timeout_secs\" disables this message. task:kworker/u16:0   state:D stack:    0 pid:    9 ppid:     2flags:0x00000008 Workqueue: events_unbound deferred_probe_work_func Call trace:  __switch_to+0xf4/0x1f4  __schedule+0x418/0xb80  schedule+0x5c/0x10c  schedule_preempt_disabled+0x2c/0x48  __mutex_lock+0x238/0x488  __mutex_lock_slowpath+0x1c/0x28  mutex_lock+0x50/0x74  clk_prepare_lock+0x7c/0x9c  clk_core_prepare_lock+0x20/0x44  clk_prepare+0x24/0x30  clk_bulk_prepare+0x40/0xb0  mdss_runtime_resume+0x54/0x1c8  pm_generic_runtime_resume+0x30/0x44  __genpd_runtime_resume+0x68/0x7c  genpd_runtime_resume+0x108/0x1f4  __rpm_callback+0x84/0x144  rpm_callback+0x30/0x88  rpm_resume+0x1f4/0x52c  rpm_resume+0x178/0x52c  __pm_runtime_resume+0x58/0x98  __device_attach+0xe0/0x170  device_initial_probe+0x1c/0x28  bus_probe_device+0x3c/0x9c  device_add+0x644/0x814  mipi_dsi_device_register_full+0xe4/0x170  devm_mipi_dsi_device_register_full+0x28/0x70  ti_sn_bridge_probe+0x1dc/0x2c0  auxiliary_bus_probe+0x4c/0x94  really_probe+0xcc/0x2c8  __driver_probe_device+0xa8/0x130  driver_probe_device+0x48/0x110  __device_attach_driver+0xa4/0xcc  bus_for_each_drv+0x8c/0xd8  __device_attach+0xf8/0x170  device_initial_probe+0x1c/0x28  bus_probe_device+0x3c/0x9c  deferred_probe_work_func+0x9c/0xd8  process_one_work+0x148/0x518  worker_thread+0x138/0x350  kthread+0x138/0x1e0  ret_from_fork+0x10/0x20The first thread is walking the clk tree and callingclk_pm_runtime_get() to power on devices required to read the clkhardware via struct clk_ops::is_enabled(). This thread holds the clkprepare_lock, and is trying to runtime PM resume a device, when it findsthat the device is in the process of resuming so the thread schedule()saway waiting for the device to finish resuming before continuing. Thesecond thread is runtime PM resuming the same device, but the runtimeresume callback is calling clk_prepare(), trying to grab theprepare_lock waiting on the first thread.This is a classic ABBA deadlock. To properly fix the deadlock, we mustnever runtime PM resume or suspend a device with the clk prepare_lockheld. Actually doing that is near impossible today because the globalprepare_lock would have to be dropped in the middle of the tree, thedevice runtime PM resumed/suspended, and then the prepare_lock grabbedagain to ensure consistency of the clk tree topology. If anythingchanges with the clk tree in the meantime, we've lost and will need tostart the operation all over again.Luckily, most of the time we're simply incrementing or decrementing theruntime PM count on an active device, so we don't have the chance toschedule away with the prepare_lock held. Let's fix this immediateproblem that can be---truncated---",
		"affected": {
			"family": "unix",
			"platform": "Ubuntu 22.04 LTS"
		},
		"reference": {
			"source": "CVE",
			"ref_id": "CVE-2024-27004",
			"ref_url": "https://www.cve.org/CVERecord?id=CVE-2024-27004"
		},
		"advisory": {
			"severity": "Medium",
			"rights": "Copyright (C) 2024 Canonical Ltd.",
			"public_date": "2024-05-01 06:15:00 UTC",
			"cve": {
				"text": "CVE-2024-27004",
				"href": "https://ubuntu.com/security/CVE-2024-27004",
				"public": "20240501"
			}
		}
	},
	"notes": {},
	"criteria": {
		"criterias": [
			{
				"operator": "OR",
				"criterions": [
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000000",
						"comment": "linux package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000160",
						"comment": "linux-hwe-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-hwe-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000270",
						"comment": "linux-hwe-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-hwe-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000350",
						"comment": "linux-hwe-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000050",
						"comment": "linux-kvm package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000240",
						"comment": "linux-allwinner-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000010",
						"comment": "linux-aws package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000220",
						"comment": "linux-aws-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000260",
						"comment": "linux-aws-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-aws-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000380",
						"comment": "linux-aws-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000030",
						"comment": "linux-azure package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000180",
						"comment": "linux-azure-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000300",
						"comment": "linux-azure-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000390",
						"comment": "linux-azure-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000100",
						"comment": "linux-azure-fde package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000190",
						"comment": "linux-azure-fde-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-azure-fde-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000310",
						"comment": "linux-azure-fde-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'replaced by linux-azure-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000040",
						"comment": "linux-gcp package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000230",
						"comment": "linux-gcp-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000290",
						"comment": "linux-gcp-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-gcp-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000400",
						"comment": "linux-gcp-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000020",
						"comment": "linux-gke package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000080",
						"comment": "linux-gkeop package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000090",
						"comment": "linux-ibm package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000130",
						"comment": "linux-intel-iotg package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000110",
						"comment": "linux-lowlatency package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000170",
						"comment": "linux-lowlatency-hwe-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-lowlatency-hwe-6.2')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000280",
						"comment": "linux-lowlatency-hwe-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-lowlatency-hwe-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000360",
						"comment": "linux-lowlatency-hwe-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000210",
						"comment": "linux-nvidia package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000320",
						"comment": "linux-nvidia-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-nvidia-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000420",
						"comment": "linux-nvidia-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000060",
						"comment": "linux-oracle package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000410",
						"comment": "linux-oracle-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000120",
						"comment": "linux-oem-5.17: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oem-6.1')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000140",
						"comment": "linux-oem-6.0: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oem-6.1')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000150",
						"comment": "linux-oem-6.1: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-oem-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000340",
						"comment": "linux-oem-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000070",
						"comment": "linux-raspi package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000250",
						"comment": "linux-starfive-5.19: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'end of kernel support')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000330",
						"comment": "linux-starfive-6.2: while related to the CVE in some way, a decision has been made to ignore this issue (note: 'superseded by linux-starfive-6.5')."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000370",
						"comment": "linux-starfive-6.5 package in jammy is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.jammy:tst:201245420000200",
						"comment": "linux-xilinx-zynqmp package in jammy is affected and may need fixing."
					}
				]
			}
		]
	}
}
