{
	"class": "vulnerability",
	"id": "oval:com.ubuntu.noble:def:2024499930000000",
	"version": "1",
	"metadata": {
		"title": "CVE-2024-49993 on Ubuntu 24.04 LTS (noble) - medium",
		"description": "In the Linux kernel, the following vulnerability has been resolved:iommu/vt-d: Fix potential lockup if qi_submit_sync called with 0 countIf qi_submit_sync() is invoked with 0 invalidation descriptors (forinstance, for DMA draining purposes), we can run into a bug where asubmitting thread fails to detect the completion of invalidation_wait.Subsequently, this led to a soft lockup. Currently, there is no impactby this bug on the existing users because no callers are submittinginvalidations with 0 descriptors. This fix will enable future users(such as DMA drain) calling qi_submit_sync() with 0 count.Suppose thread T1 invokes qi_submit_sync() with non-zero descriptors, whileconcurrently, thread T2 calls qi_submit_sync() with zero descriptors. Boththreads then enter a while loop, waiting for their respective descriptorsto complete. T1 detects its completion (i.e., T1's invalidation_wait statuschanges to QI_DONE by HW) and proceeds to call reclaim_free_desc() toreclaim all descriptors, potentially including adjacent ones of otherthreads that are also marked as QI_DONE.During this time, while T2 is waiting to acquire the qi->q_lock, the IOMMUhardware may complete the invalidation for T2, setting its status toQI_DONE. However, if T1's execution of reclaim_free_desc() frees T2'sinvalidation_wait descriptor and changes its status to QI_FREE, T2 willnot observe the QI_DONE status for its invalidation_wait and willindefinitely remain stuck.This soft lockup does not occur when only non-zero descriptors aresubmitted.In such cases, invalidation descriptors are interspersed amongwait descriptors with the status QI_IN_USE, acting as barriers. Thesebarriers prevent the reclaim code from mistakenly freeing descriptorsbelonging to other submitters.Considered the following example timeline:\tT1\t\t\tT2========================================\tID1\tWD1\twhile(WD1!=QI_DONE)\tunlock\t\t\t\tlock\tWD1=QI_DONE*\t\tWD2\t\t\t\twhile(WD2!=QI_DONE)\t\t\t\tunlock\tlock\tWD1==QI_DONE?\tID1=QI_DONE\t\tWD2=DONE*\treclaim()\tID1=FREE\tWD1=FREE\tWD2=FREE\tunlock\t\t\t\tsoft lockup! T2 never sees QI_DONE in WD2Where:ID = invalidation descriptorWD = wait descriptor* Written by hardwareThe root of the problem is that the descriptor status QI_DONE flag is usedfor two conflicting purposes:1. signal a descriptor is ready for reclaim (to be freed)2. signal by the hardware that a wait descriptor is completeThe solution (in this patch) is state separation by using QI_FREE flagfor #1.Once a thread's invalidation descriptors are complete, their status wouldbe set to QI_FREE. The reclaim_free_desc() function would then onlyfree descriptors marked as QI_FREE instead of those marked asQI_DONE. This change ensures that T2 (from the previous example) willcorrectly observe the completion of its invalidation_wait (marked asQI_DONE).",
		"affected": {
			"family": "unix",
			"platform": "Ubuntu 24.04 LTS"
		},
		"reference": {
			"source": "CVE",
			"ref_id": "CVE-2024-49993",
			"ref_url": "https://www.cve.org/CVERecord?id=CVE-2024-49993"
		},
		"advisory": {
			"severity": "Medium",
			"rights": "Copyright (C) 2024 Canonical Ltd.",
			"public_date": "2024-10-21 18:15:00 UTC",
			"cve": {
				"text": "CVE-2024-49993",
				"href": "https://ubuntu.com/security/CVE-2024-49993",
				"public": "20241021",
				"cvss_score": "5.5",
				"cvss_vector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H"
			}
		}
	},
	"notes": {},
	"criteria": {
		"criterias": [
			{
				"operator": "OR",
				"criterions": [
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000000",
						"comment": "linux package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000010",
						"comment": "linux-aws package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000030",
						"comment": "linux-azure package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000040",
						"comment": "linux-gcp package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000020",
						"comment": "linux-gke package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000070",
						"comment": "linux-ibm package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000080",
						"comment": "linux-lowlatency package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000050",
						"comment": "linux-oracle package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000090",
						"comment": "linux-oem-6.8 package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000060",
						"comment": "linux-raspi package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000110",
						"comment": "linux-raspi-realtime package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000120",
						"comment": "linux-realtime package in noble is affected and needs fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000100",
						"comment": "linux-intel package in noble is affected and needs fixing."
					}
				]
			}
		]
	}
}
