{
	"class": "vulnerability",
	"id": "oval:com.ubuntu.noble:def:2024357840000000",
	"version": "1",
	"metadata": {
		"title": "CVE-2024-35784 on Ubuntu 24.04 LTS (noble) - medium",
		"description": "In the Linux kernel, the following vulnerability has been resolved:btrfs: fix deadlock with fiemap and extent lockingWhile working on the patchset to remove extent locking I got a lockdepsplat with fiemap and pagefaulting with my new extent lock replacementlock.This deadlock exists with our normal code, we just don't have lockdepannotations with the extent locking so we've never noticed it.Since we're copying the fiemap extent to user space on every iterationwe have the chance of pagefaulting.  Because we hold the extent lock forthe entire range we could mkwrite into a range in the file that we havemmap'ed.  This would deadlock with the following stack trace[<0>] lock_extent+0x28d/0x2f0[<0>] btrfs_page_mkwrite+0x273/0x8a0[<0>] do_page_mkwrite+0x50/0xb0[<0>] do_fault+0xc1/0x7b0[<0>] __handle_mm_fault+0x2fa/0x460[<0>] handle_mm_fault+0xa4/0x330[<0>] do_user_addr_fault+0x1f4/0x800[<0>] exc_page_fault+0x7c/0x1e0[<0>] asm_exc_page_fault+0x26/0x30[<0>] rep_movs_alternative+0x33/0x70[<0>] _copy_to_user+0x49/0x70[<0>] fiemap_fill_next_extent+0xc8/0x120[<0>] emit_fiemap_extent+0x4d/0xa0[<0>] extent_fiemap+0x7f8/0xad0[<0>] btrfs_fiemap+0x49/0x80[<0>] __x64_sys_ioctl+0x3e1/0xb50[<0>] do_syscall_64+0x94/0x1a0[<0>] entry_SYSCALL_64_after_hwframe+0x6e/0x76I wrote an fstest to reproduce this deadlock without my replacement lockand verified that the deadlock exists with our existing locking.To fix this simply don't take the extent lock for the entire duration ofthe fiemap.  This is safe in general because we keep track of where weare when we're searching the tree, so if an ordered extent updates inthe middle of our fiemap call we'll still emit the correct extentsbecause we know what offset we were on before.The only place we maintain the lock is searching delalloc.  Since thedelalloc stuff can change during writeback we want to lock the extentrange so we have a consistent view of delalloc at the time we'rechecking to see if we need to set the delalloc flag.With this patch applied we no longer deadlock with my testcase.",
		"affected": {
			"family": "unix",
			"platform": "Ubuntu 24.04 LTS"
		},
		"reference": {
			"source": "CVE",
			"ref_id": "CVE-2024-35784",
			"ref_url": "https://www.cve.org/CVERecord?id=CVE-2024-35784"
		},
		"advisory": {
			"severity": "Medium",
			"rights": "Copyright (C) 2024 Canonical Ltd.",
			"public_date": "2024-05-20",
			"cve": {
				"text": "CVE-2024-35784",
				"href": "https://ubuntu.com/security/CVE-2024-35784",
				"public": "20240520"
			}
		}
	},
	"notes": {},
	"criteria": {
		"criterias": [
			{
				"operator": "OR",
				"criterions": [
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000000",
						"comment": "linux package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000010",
						"comment": "linux-aws package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000030",
						"comment": "linux-azure package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000040",
						"comment": "linux-gcp package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000020",
						"comment": "linux-gke package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000070",
						"comment": "linux-ibm package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000080",
						"comment": "linux-lowlatency package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000050",
						"comment": "linux-oracle package in noble is affected and may need fixing."
					},
					{
						"test_ref": "oval:com.ubuntu.noble:tst:201245420000060",
						"comment": "linux-raspi package in noble is affected and may need fixing."
					}
				]
			}
		]
	}
}
